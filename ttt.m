function [Zt]=ttt(HSI, K,sz,up_scale,t)
F=create_F();
s0=1;
psf        =    fspecial('gaussian',7,2);
par.fft_B      =    psf2otf(psf,sz);
par.fft_BT     =    conj(par.fft_B);
par.H          =    @(z)H_z(z, par.fft_B, up_scale, sz,s0 );
par.HT         =    @(y)HT_y(y, par.fft_BT, up_scale, sz,s0);
par.P=create_F();
for band = 1:size(F,1) 
    div = sum(F(band,:));
    for i = 1:size(F,2)
        F(band,i) = F(band,i)/div;
    end
end
R=F;
mu=1e-3;
patchsize=8;
overlap=4;
bparams.block_sz = [patchsize, patchsize];
bparams.overlap_sz=[overlap overlap];
MSI=t;
HSI=imresize(HSI,1/up_scale);
[nr, nc,~]=size(MSI);
L=size(HSI,3);
num1=(nr-patchsize)/(patchsize-overlap)+1;
num2=(nc-patchsize)/(patchsize-overlap)+1;
bparams.block_num=[num1 num2]; 
fkmeans_omaxpt.careful = 1;
predenoised_blocks = ExtractBlocks(MSI, bparams);
Y2=Unfold(predenoised_blocks,size(predenoised_blocks),4);   
[aa ]=fkmeans(Y2,K,fkmeans_omaxpt);
mu=1e-3;
patchsize=8;
overlap=4;
bparams.block_sz = [patchsize, patchsize];
bparams.overlap_sz=[overlap overlap];
[nr, nc,~]=size(MSI);
L=size(HSI,3);
num1=(nr-patchsize)/(patchsize-overlap)+1;
num2=(nc-patchsize)/(patchsize-overlap)+1;
bparams.block_num=[num1 num2]; 
fkmeans_omaxpt.careful = 1;
predenoised_blocks = ExtractBlocks(MSI, bparams);
Y2=Unfold(predenoised_blocks,size(predenoised_blocks),4);  
[aa ]=fkmeans(Y2,K,fkmeans_omaxpt);
FBm=par.fft_B;
HSI_int=zeros(nr,nc,L);
HSI_int(1:up_scale:end,1:up_scale:end,:)=HSI;
FBmC  = conj(FBm);
FBs  = repmat(FBm,[1 1 L]);
FBCs1=repmat(FBmC,[1 1 L]);
HHH=ifft2((fft2(HSI_int).*FBCs1));
HHH1=hyperConvert2D(HHH);
psfY.w=nr/up_scale;
psfY.h=nc/up_scale;
psfY.W=nr;
psfY.H=nc;
Zt=HSI_int;
HR_load1=imresize(HSI, up_scale,'bicubic');
ZE=hyperConvert2D(HR_load1);
MSI3=Unfold(MSI,size(MSI),3);
n_dr=nr/up_scale;
n_dc=nc/up_scale;
V1=ZE;
V2=ZE;
V3=ZE;
G1=zeros(size(V1));
G2=zeros(size(V2));
G3=zeros(size(V3));
CCC=R'*MSI3+HHH1;
C1=R'*R+3*mu*eye(size(R,2)); 
[Q,Lambda]=eig(C1);                        
Lambda=reshape(diag(Lambda),[1 1 L]);
InvLbd=1./repmat(Lambda,[ up_scale*n_dr  up_scale*n_dc 1]);   
B2Sum=PPlus(abs(FBs).^2./( up_scale^2),n_dr,n_dc);
InvDI=1./(B2Sum(1:n_dr,1:n_dc,:)+repmat(Lambda,[n_dr n_dc 1]));
HR_HSI3=mu*(V1+G1/(2*mu)+V2+G2/(2*mu)+V3+G3/(2*mu));
C3=CCC+HR_HSI3;
C30=fft2(reshape((Q\C3)',[nr nc L   ])).*InvLbd;
temp  = PPlus_s(C30/( up_scale^2).*FBs,n_dr,n_dc);         
invQUF = C30-repmat(temp.*InvDI,[ up_scale  up_scale 1]).*FBCs1;
VXF    = Q*reshape(invQUF,[nc*nc L])';
ZE = reshape(real(ifft2(reshape(VXF',[nr nc L]))),[nc*nc L])';
Zt=hyperConvert3D(ZE,nr, nc );
